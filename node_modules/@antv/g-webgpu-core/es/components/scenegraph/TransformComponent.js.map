{"version":3,"sources":["../../../src/components/scenegraph/TransformComponent.ts"],"names":["mat4","quat","vec3","Component","TransformComponent","data","dirtyFlag","localTranslation","fromValues","localRotation","localScale","localTransform","create","worldTransform","getRotation","rotation","getScale","scaling","getScaling","getPosition","translation","getTranslation","getLocalMatrix","rts","fromRotationTranslationScale","matrixTransform","transformed","mat","multiply","rotateRollPitchYaw","quatX","quatY","quatZ","x","y","z","setDirty","fromEuler","normalize","lerp","aS","aR","aT","bS","bR","bT","a","b","t","slerp","value","DIRTY","isDirty","copy","parent","add","quaternion"],"mappings":"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","sourcesContent":["import { mat4, quat, vec3, vec4 } from 'gl-matrix';\nimport { Component, NonFunctionProperties } from '../../ComponentManager';\n\nexport class TransformComponent extends Component<TransformComponent> {\n  public static DIRTY = 1 << 0;\n\n  public dirtyFlag: number;\n\n  /**\n   * local space RTS\n   */\n\n  /**\n   * XMFLOAT4X4._41\n   * @see https://docs.microsoft.com/en-us/windows/win32/api/directxmath/nf-directxmath-xmfloat4x4-xmfloat4x4(constfloat)#remarks\n   */\n  public localTranslation = vec3.fromValues(0, 0, 0);\n  public localRotation = quat.fromValues(0, 0, 0, 1);\n  public localScale = vec3.fromValues(1, 1, 1);\n  public localTransform = mat4.create();\n\n  /**\n   * world space RTS\n   */\n\n  // public position = vec3.fromValues(0, 0, 0);\n  // public rotation = quat.fromValues(0, 0, 0, 1);\n  public worldTransform = mat4.create();\n\n  // 高阶函数，利用闭包重复利用临时变量\n  // @see playcanvas graph node\n  public getRotation = (() => {\n    const rotation = quat.create();\n    return () => {\n      mat4.getRotation(rotation, this.worldTransform);\n      return rotation;\n    };\n  })();\n\n  public getScale = (() => {\n    const scaling = vec3.create();\n    return () => {\n      mat4.getScaling(scaling, this.worldTransform);\n      return scaling;\n    };\n  })();\n\n  public getPosition = (() => {\n    const translation = vec3.create();\n    return () => {\n      mat4.getTranslation(translation, this.worldTransform);\n      return translation;\n    };\n  })();\n\n  public getLocalMatrix = (() => {\n    const rts = mat4.create();\n    return () => {\n      mat4.fromRotationTranslationScale(\n        rts,\n        this.localRotation,\n        this.localTranslation,\n        this.localScale,\n      );\n      return rts;\n    };\n  })();\n\n  public matrixTransform = (() => {\n    const transformed = mat4.create();\n    return (mat: mat4) => {\n      mat4.multiply(transformed, this.getLocalMatrix(), mat);\n      mat4.getScaling(this.localScale, transformed);\n      mat4.getTranslation(this.localTranslation, transformed);\n      mat4.getRotation(this.localRotation, transformed);\n    };\n  })();\n\n  /**\n   * @see https://docs.microsoft.com/en-us/windows/win32/api/directxmath/nf-directxmath-xmquaternionrotationrollpitchyaw\n   */\n  public rotateRollPitchYaw = (() => {\n    const quatX = quat.create();\n    const quatY = quat.create();\n    const quatZ = quat.create();\n    return (x: number, y: number, z: number) => {\n      this.setDirty();\n\n      quat.fromEuler(quatX, x, 0, 0);\n      quat.fromEuler(quatY, 0, y, 0);\n      quat.fromEuler(quatZ, 0, 0, z);\n\n      quat.multiply(this.localRotation, quatX, this.localRotation);\n      quat.multiply(this.localRotation, this.localRotation, quatY);\n      quat.multiply(this.localRotation, quatZ, this.localRotation);\n      quat.normalize(this.localRotation, this.localRotation);\n    };\n  })();\n\n  /**\n   * @see https://xiaoiver.github.io/coding/2018/12/28/Camera-%E8%AE%BE%E8%AE%A1-%E4%B8%80.html\n   */\n  public lerp = (() => {\n    const aS = vec3.create();\n    const aR = quat.create();\n    const aT = vec3.create();\n    const bS = vec3.create();\n    const bR = quat.create();\n    const bT = vec3.create();\n    return (a: TransformComponent, b: TransformComponent, t: number) => {\n      this.setDirty();\n\n      mat4.getScaling(aS, a.worldTransform);\n      mat4.getTranslation(aT, a.worldTransform);\n      mat4.getRotation(aR, a.worldTransform);\n      mat4.getScaling(bS, b.worldTransform);\n      mat4.getTranslation(bT, b.worldTransform);\n      mat4.getRotation(bR, b.worldTransform);\n\n      vec3.lerp(this.localScale, aS, bS, t);\n      quat.slerp(this.localRotation, aR, bR, t);\n      vec3.lerp(this.localTranslation, aT, bT, t);\n    };\n  })();\n\n  /**\n   * @see https://en.wikipedia.org/wiki/Centripetal_Catmull%E2%80%93Rom_spline\n   */\n  // public catmullRom = (() => {\n  //   const aS = vec3.create();\n  //   const aR = quat.create();\n  //   const aT = vec3.create();\n  //   const bS = vec3.create();\n  //   const bR = quat.create();\n  //   const bT = vec3.create();\n  //   const cS = vec3.create();\n  //   const cR = quat.create();\n  //   const cT = vec3.create();\n  //   const dS = vec3.create();\n  //   const dR = quat.create();\n  //   const dT = vec3.create();\n  //   const R = quat.create();\n  //   return (\n  //     a: TransformComponent,\n  //     b: TransformComponent,\n  //     c: TransformComponent,\n  //     d: TransformComponent,\n  //     t: number,\n  //   ) => {\n  //     this.setDirty();\n  //     mat4.getScaling(aS, a.worldTransform);\n  //     mat4.getTranslation(aT, a.worldTransform);\n  //     mat4.getRotation(aR, a.worldTransform);\n  //     mat4.getScaling(bS, b.worldTransform);\n  //     mat4.getTranslation(bT, b.worldTransform);\n  //     mat4.getRotation(bR, b.worldTransform);\n  //     mat4.getScaling(cS, c.worldTransform);\n  //     mat4.getTranslation(cT, c.worldTransform);\n  //     mat4.getRotation(cR, c.worldTransform);\n  //     mat4.getScaling(dS, d.worldTransform);\n  //     mat4.getTranslation(dT, d.worldTransform);\n  //     mat4.getRotation(dR, d.worldTransform);\n\n  //     vec3.catmullRom(this.localTranslation, aT, bT, cT, dT, t);\n  //     vec3.catmullRom(R, aR, bR, cR, dR, t);\n  //     quat.normalize(this.localRotation, R);\n  //     vec3.catmullRom(this.localScale, aS, bS, cS, dS, t);\n  //   };\n  // })();\n\n  constructor(data?: Partial<NonFunctionProperties<TransformComponent>>) {\n    super(data);\n  }\n\n  public isDirty() {\n    return this.dirtyFlag;\n  }\n\n  public setDirty(value = true) {\n    if (value) {\n      this.dirtyFlag |= TransformComponent.DIRTY;\n    } else {\n      this.dirtyFlag &= ~TransformComponent.DIRTY;\n    }\n  }\n\n  public updateTransform() {\n    if (this.isDirty()) {\n      this.setDirty(false);\n      mat4.copy(this.worldTransform, this.getLocalMatrix());\n    }\n  }\n\n  public updateTransformWithParent(parent: TransformComponent) {\n    mat4.multiply(\n      this.worldTransform,\n      this.getLocalMatrix(),\n      parent.worldTransform,\n    );\n  }\n\n  public applyTransform() {\n    this.setDirty();\n\n    mat4.getScaling(this.localScale, this.worldTransform);\n    mat4.getTranslation(this.localTranslation, this.worldTransform);\n    mat4.getRotation(this.localRotation, this.worldTransform);\n  }\n\n  public clearTransform() {\n    this.setDirty();\n    this.localTranslation = vec3.fromValues(0, 0, 0);\n    this.localRotation = quat.fromValues(0, 0, 0, 1);\n    this.localScale = vec3.fromValues(1, 1, 1);\n  }\n\n  /**\n   * TODO: 支持以下两种：\n   * * translate(x, y, z)\n   * * translate(vec3(x, y, z))\n   */\n  public translate(translation: vec3) {\n    this.setDirty();\n    vec3.add(this.localTranslation, this.localTranslation, translation);\n    return this;\n  }\n\n  public scale(scaling: vec3) {\n    this.setDirty();\n    vec3.multiply(this.localScale, this.localScale, scaling);\n    return this;\n  }\n\n  public rotate(quaternion: quat) {\n    this.setDirty();\n    quat.multiply(this.localRotation, this.localRotation, quaternion);\n    quat.normalize(this.localRotation, this.localRotation);\n    return this;\n  }\n}\n"],"file":"TransformComponent.js"}