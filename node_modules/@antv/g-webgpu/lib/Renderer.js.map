{"version":3,"sources":["../src/Renderer.ts"],"names":["Renderer","IDENTIFIER","RenderEngine","ShaderModuleService","ConfigService","inited","rendering","pendings","views","size","container","shaderModule","registerBuiltinModules","systems","getAll","Systems","config","configService","get","canvas","engine","init","swapChainFormat","WebGPUConstants","TextureFormat","BGRA8Unorm","antialiasing","system","initialize","length","forEach","pending","beginFrame","execute","endFrame","options","clear","unshift","shift","width","height","getCanvas"],"mappings":"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","sourcesContent":["import {\n  IClearOptions,\n  IConfigService,\n  IDENTIFIER,\n  IRendererService,\n  IShaderModuleService,\n  ISystem,\n  IView,\n} from '@antv/g-webgpu-core';\n// tslint:disable-next-line:no-submodule-imports\nimport * as WebGPUConstants from '@webgpu/types/dist/constants';\nimport { Container, inject, injectable, multiInject } from 'inversify';\n\n@injectable()\nexport class Renderer {\n  @inject(IDENTIFIER.RenderEngine)\n  private readonly engine: IRendererService;\n\n  @inject(IDENTIFIER.ShaderModuleService)\n  private readonly shaderModule: IShaderModuleService;\n\n  @inject(IDENTIFIER.ConfigService)\n  private readonly configService: IConfigService;\n\n  // @multiInject(IDENTIFIER.Systems)\n  // private readonly systems: ISystem[];\n\n  private inited: boolean = false;\n\n  private rendering: boolean = false;\n\n  private pendings: Array<() => void> = [];\n\n  private views: IView[] = [];\n  private size: { width: number; height: number };\n\n  public container: Container;\n\n  public async init() {\n    // 模块化处理\n    this.shaderModule.registerBuiltinModules();\n\n    const systems = this.container.getAll<ISystem>(IDENTIFIER.Systems);\n\n    const config = this.configService.get();\n\n    if (config.canvas) {\n      await this.engine.init({\n        canvas: config.canvas,\n        swapChainFormat: WebGPUConstants.TextureFormat.BGRA8Unorm,\n        antialiasing: false,\n      });\n\n      for (const system of systems) {\n        if (system.initialize) {\n          await system.initialize();\n        }\n      }\n\n      this.inited = true;\n    }\n  }\n\n  public async render(...views: IView[]) {\n    if (!this.inited || this.rendering) {\n      return;\n    }\n\n    if (this.pendings.length) {\n      this.pendings.forEach((pending) => {\n        pending();\n      });\n    }\n\n    this.rendering = true;\n    this.engine.beginFrame();\n\n    const systems = this.container.getAll<ISystem>(IDENTIFIER.Systems);\n    for (const system of systems) {\n      if (system.execute) {\n        await system.execute(views);\n      }\n    }\n\n    // 录制一遍绘制命令，后续直接播放\n    // if (this.useRenderBundle) {\n    //   if (!this.renderBundleRecorded) {\n    //     this.engine.startRecordBundle();\n    //     if (this.onUpdate) {\n    //       await this.onUpdate(this.engine);\n    //     }\n    //     this.renderBundle = this.engine.stopRecordBundle();\n    //     this.renderBundleRecorded = true;\n    //   }\n    //   this.engine.executeBundles([this.renderBundle]);\n    // } else {\n    //   if (this.onUpdate) {\n    //     await this.onUpdate(this.engine);\n    //   }\n    // }\n\n    this.engine.endFrame();\n    this.rendering = false;\n  }\n\n  public clear(options: IClearOptions) {\n    if (this.inited) {\n      this.engine.clear(options);\n    } else {\n      this.pendings.unshift(() => {\n        this.engine.clear(options);\n        this.pendings.shift();\n      });\n    }\n    return this;\n  }\n\n  // public setScissor(\n  //   scissor: Partial<{\n  //     enable: boolean;\n  //     box: {\n  //       x: number;\n  //       y: number;\n  //       width: number;\n  //       height: number;\n  //     };\n  //   }>,\n  // ) {\n  //   this.engine.setScissor(scissor);\n  //   return this;\n  // }\n\n  public setSize({ width, height }: { width: number; height: number }) {\n    const canvas = this.engine.getCanvas();\n    this.size = { width, height };\n    canvas.width = width;\n    canvas.height = height;\n    return this;\n  }\n\n  public getSize() {\n    return this.size;\n  }\n}\n"],"file":"Renderer.js"}