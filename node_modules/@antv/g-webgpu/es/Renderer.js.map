{"version":3,"sources":["../src/Renderer.ts"],"names":["IDENTIFIER","WebGPUConstants","inject","injectable","Renderer","RenderEngine","ShaderModuleService","ConfigService","inited","rendering","pendings","views","size","container","shaderModule","registerBuiltinModules","systems","getAll","Systems","config","configService","get","canvas","engine","init","swapChainFormat","TextureFormat","BGRA8Unorm","antialiasing","system","initialize","length","forEach","pending","beginFrame","execute","endFrame","options","clear","unshift","shift","width","height","getCanvas"],"mappings":"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","sourcesContent":["import {\n  IClearOptions,\n  IConfigService,\n  IDENTIFIER,\n  IRendererService,\n  IShaderModuleService,\n  ISystem,\n  IView,\n} from '@antv/g-webgpu-core';\n// tslint:disable-next-line:no-submodule-imports\nimport * as WebGPUConstants from '@webgpu/types/dist/constants';\nimport { Container, inject, injectable, multiInject } from 'inversify';\n\n@injectable()\nexport class Renderer {\n  @inject(IDENTIFIER.RenderEngine)\n  private readonly engine: IRendererService;\n\n  @inject(IDENTIFIER.ShaderModuleService)\n  private readonly shaderModule: IShaderModuleService;\n\n  @inject(IDENTIFIER.ConfigService)\n  private readonly configService: IConfigService;\n\n  // @multiInject(IDENTIFIER.Systems)\n  // private readonly systems: ISystem[];\n\n  private inited: boolean = false;\n\n  private rendering: boolean = false;\n\n  private pendings: Array<() => void> = [];\n\n  private views: IView[] = [];\n  private size: { width: number; height: number };\n\n  public container: Container;\n\n  public async init() {\n    // 模块化处理\n    this.shaderModule.registerBuiltinModules();\n\n    const systems = this.container.getAll<ISystem>(IDENTIFIER.Systems);\n\n    const config = this.configService.get();\n\n    if (config.canvas) {\n      await this.engine.init({\n        canvas: config.canvas,\n        swapChainFormat: WebGPUConstants.TextureFormat.BGRA8Unorm,\n        antialiasing: false,\n      });\n\n      for (const system of systems) {\n        if (system.initialize) {\n          await system.initialize();\n        }\n      }\n\n      this.inited = true;\n    }\n  }\n\n  public async render(...views: IView[]) {\n    if (!this.inited || this.rendering) {\n      return;\n    }\n\n    if (this.pendings.length) {\n      this.pendings.forEach((pending) => {\n        pending();\n      });\n    }\n\n    this.rendering = true;\n    this.engine.beginFrame();\n\n    const systems = this.container.getAll<ISystem>(IDENTIFIER.Systems);\n    for (const system of systems) {\n      if (system.execute) {\n        await system.execute(views);\n      }\n    }\n\n    // 录制一遍绘制命令，后续直接播放\n    // if (this.useRenderBundle) {\n    //   if (!this.renderBundleRecorded) {\n    //     this.engine.startRecordBundle();\n    //     if (this.onUpdate) {\n    //       await this.onUpdate(this.engine);\n    //     }\n    //     this.renderBundle = this.engine.stopRecordBundle();\n    //     this.renderBundleRecorded = true;\n    //   }\n    //   this.engine.executeBundles([this.renderBundle]);\n    // } else {\n    //   if (this.onUpdate) {\n    //     await this.onUpdate(this.engine);\n    //   }\n    // }\n\n    this.engine.endFrame();\n    this.rendering = false;\n  }\n\n  public clear(options: IClearOptions) {\n    if (this.inited) {\n      this.engine.clear(options);\n    } else {\n      this.pendings.unshift(() => {\n        this.engine.clear(options);\n        this.pendings.shift();\n      });\n    }\n    return this;\n  }\n\n  // public setScissor(\n  //   scissor: Partial<{\n  //     enable: boolean;\n  //     box: {\n  //       x: number;\n  //       y: number;\n  //       width: number;\n  //       height: number;\n  //     };\n  //   }>,\n  // ) {\n  //   this.engine.setScissor(scissor);\n  //   return this;\n  // }\n\n  public setSize({ width, height }: { width: number; height: number }) {\n    const canvas = this.engine.getCanvas();\n    this.size = { width, height };\n    canvas.width = width;\n    canvas.height = height;\n    return this;\n  }\n\n  public getSize() {\n    return this.size;\n  }\n}\n"],"file":"Renderer.js"}