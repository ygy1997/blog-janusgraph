{"version":3,"sources":["../src/World.ts"],"names":["createEntity","createWorldContainer","IDENTIFIER","WebGLEngine","WebGPUEngine","WebGPUConstants","inject","injectable","Camera","Kernel","Line","Point","Renderable","Renderer","Scene","createCanvas","View","World","ConfigService","container","engine","get","RenderEngine","configService","canvas","engineOptions","init","swapChainFormat","TextureFormat","BGRA8Unorm","antialiasing","entity","manager","TransformComponentManager","getComponentByEntity","MeshComponentManager","config","set","type","renderable","getNamed","setConfig","setEntity","params","geometrySystem","Systems","GeometrySystem","createBox","createBufferGeometry","createInstancedBufferGeometry","materialSystem","MaterialSystem","createBasicMaterial","createShaderMaterial","precompiledBundle","kernel","setBundle","JSON","parse","renderer","systems","getAll","forEach","system","tearDown","destroy","interactor","InteractorService","worldContainer","engineClazz","navigator","gpu","isBound","bind","to","inSingletonScope","toSelf","whenTargetNamed","POINT","LINE","world","setContainer"],"mappings":"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","sourcesContent":["// tslint:disable-next-line:no-reference\n/// <reference path=\"../../../node_modules/@webgpu/types/dist/index.d.ts\" />\nimport {\n  ComponentManager,\n  createEntity,\n  createWorldContainer,\n  Entity,\n  GeometrySystem,\n  // container,\n  IBoxGeometryParams,\n  IConfig,\n  IConfigService,\n  IDENTIFIER,\n  IInteractorService,\n  IRendererService,\n  ISystem,\n  KernelBundle,\n  MaterialSystem,\n  MeshComponent,\n  TransformComponent,\n} from '@antv/g-webgpu-core';\nimport { WebGLEngine, WebGPUEngine } from '@antv/g-webgpu-engine';\n// tslint:disable-next-line:no-submodule-imports\nimport * as WebGPUConstants from '@webgpu/types/dist/constants';\nimport { Container, inject, injectable } from 'inversify';\nimport { Camera } from './camera/Camera';\nimport { Kernel } from './Kernel';\nimport { Line } from './renderable/line/Line';\nimport { Point } from './renderable/point/Point';\nimport { IRenderable, Renderable } from './renderable/Renderable';\nimport { Renderer } from './Renderer';\nimport { Scene } from './Scene';\nimport { createCanvas } from './utils/canvas';\nimport { View } from './View';\n\n@injectable()\nexport class World {\n  public static create(config: Partial<IConfig> = {}) {\n    const worldContainer = createWorldContainer();\n\n    // bind render engine, fallback to WebGL\n    const engineClazz = !navigator.gpu ? WebGLEngine : WebGPUEngine;\n    if (!worldContainer.isBound(IDENTIFIER.RenderEngine)) {\n      worldContainer\n        .bind<IRendererService>(IDENTIFIER.RenderEngine)\n        // @ts-ignore\n        .to(engineClazz)\n        .inSingletonScope();\n    }\n\n    worldContainer.bind(Renderer).toSelf();\n    worldContainer.bind(Kernel).toSelf();\n    worldContainer.bind(Renderable).toSelf();\n    worldContainer.bind(View).toSelf();\n    worldContainer.bind(Camera).toSelf();\n    worldContainer.bind(Scene).toSelf();\n    worldContainer.bind(World).toSelf();\n\n    worldContainer\n      .bind<IRenderable<unknown>>(IDENTIFIER.Renderable)\n      .to(Point)\n      .whenTargetNamed(Renderable.POINT);\n    worldContainer\n      .bind<IRenderable<unknown>>(IDENTIFIER.Renderable)\n      .to(Line)\n      .whenTargetNamed(Renderable.LINE);\n\n    const world = worldContainer.get(World);\n    world.setContainer(worldContainer);\n    world.setConfig(config);\n    return world;\n  }\n\n  @inject(IDENTIFIER.ConfigService)\n  private readonly configService: IConfigService;\n\n  private container: Container;\n\n  public async getEngine() {\n    const engine = this.container.get<IRendererService>(\n      IDENTIFIER.RenderEngine,\n    );\n    const { canvas, engineOptions } = this.configService.get();\n    await engine.init({\n      canvas: canvas || createCanvas(),\n      swapChainFormat: WebGPUConstants.TextureFormat.BGRA8Unorm,\n      antialiasing: false,\n      ...engineOptions,\n    });\n    return engine;\n  }\n\n  /**\n   * get transform component\n   * @param entity\n   */\n  public getTransformComponent(entity: Entity) {\n    const manager = this.container.get<ComponentManager<TransformComponent>>(\n      IDENTIFIER.TransformComponentManager,\n    );\n    return manager.getComponentByEntity(entity);\n  }\n\n  public getMeshComponent(entity: Entity) {\n    const manager = this.container.get<ComponentManager<MeshComponent>>(\n      IDENTIFIER.MeshComponentManager,\n    );\n    return manager.getComponentByEntity(entity);\n  }\n\n  public setConfig(config: Partial<IConfig>) {\n    this.configService.set(config);\n  }\n\n  public setContainer(container: Container) {\n    this.container = container;\n  }\n\n  public getContainer() {\n    return this.container;\n  }\n\n  public createEntity() {\n    return createEntity();\n  }\n\n  public createScene() {\n    return this.container.get(Scene);\n  }\n\n  public createCamera() {\n    return this.container.get(Camera);\n  }\n\n  public createView() {\n    return this.container.get(View);\n  }\n\n  public createRenderable(entity: Entity, type?: string, config?: unknown) {\n    const renderable: Renderable = type\n      ? this.container.getNamed(IDENTIFIER.Renderable, type)\n      : this.container.get(Renderable);\n    renderable.setConfig(config);\n    renderable.setEntity(entity);\n    return renderable;\n  }\n\n  public createBoxGeometry(params: IBoxGeometryParams) {\n    const geometrySystem = this.container.getNamed<GeometrySystem>(\n      IDENTIFIER.Systems,\n      IDENTIFIER.GeometrySystem,\n    );\n    return geometrySystem.createBox(params);\n  }\n\n  public createBufferGeometry(params?: { vertexCount: number }) {\n    const geometrySystem = this.container.getNamed<GeometrySystem>(\n      IDENTIFIER.Systems,\n      IDENTIFIER.GeometrySystem,\n    );\n    return geometrySystem.createBufferGeometry(params);\n  }\n\n  public createInstancedBufferGeometry(params: {\n    maxInstancedCount: number;\n    vertexCount: number;\n  }) {\n    const geometrySystem = this.container.getNamed<GeometrySystem>(\n      IDENTIFIER.Systems,\n      IDENTIFIER.GeometrySystem,\n    );\n    return geometrySystem.createInstancedBufferGeometry(params);\n  }\n\n  public createBasicMaterial() {\n    const materialSystem = this.container.getNamed<MaterialSystem>(\n      IDENTIFIER.Systems,\n      IDENTIFIER.MaterialSystem,\n    );\n    return materialSystem.createBasicMaterial();\n  }\n\n  public createShaderMaterial(params: {\n    vertexShader: string;\n    fragmentShader: string;\n  }) {\n    const materialSystem = this.container.getNamed<MaterialSystem>(\n      IDENTIFIER.Systems,\n      IDENTIFIER.MaterialSystem,\n    );\n    return materialSystem.createShaderMaterial(params);\n  }\n\n  public createKernel(precompiledBundle: KernelBundle | string) {\n    const kernel = this.container.get(Kernel);\n    if (typeof precompiledBundle === 'string') {\n      kernel.setBundle(JSON.parse(precompiledBundle));\n    } else {\n      kernel.setBundle(precompiledBundle);\n    }\n    kernel.init();\n    return kernel;\n  }\n\n  public createRenderer() {\n    const renderer = this.container.get(Renderer);\n    renderer.container = this.container;\n    renderer.init();\n    return renderer;\n  }\n\n  public destroy() {\n    const systems = this.container.getAll<ISystem>(IDENTIFIER.Systems);\n    systems.forEach((system) => {\n      if (system.tearDown) {\n        system.tearDown();\n      }\n    });\n    const engine = this.container.get<IRendererService>(\n      IDENTIFIER.RenderEngine,\n    );\n    engine.destroy();\n    const interactor = this.container.get<IInteractorService>(\n      IDENTIFIER.InteractorService,\n    );\n    interactor.destroy();\n  }\n}\n"],"file":"World.js"}